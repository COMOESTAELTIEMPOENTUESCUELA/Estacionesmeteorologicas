<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>驴C贸mo est谩 el tiempo en tu escuela? - UNLP</title>
    
    <link rel="icon" type="image/png" href="imagenes/logo.png">
    <link rel="shortcut icon" type="image/png" href="imagenes/logo.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-database.js"></script>
    
    <link rel="stylesheet" href="styles.css">
    
    <style>
        /* Estilos CSS para el control de selecci贸n de variables */
        #mapa-controles {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 5px;
            border: 1px solid #ddd;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .leaflet-tooltip.weather-tooltip {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }
        .leaflet-tooltip small {
            font-size: 10px; /* Estilo para la hora de actualizaci贸n */
            opacity: 0.8;
            font-weight: normal;
        }
    </style>
</head>
<body>

    <header>
    <div class="logo"> 
        <img src="imagenes/logo.png" alt="Logo del Proyecto Estaciones Meteorol贸gicas">
                <h1 class="titulo-principal">C贸mo est谩 el tiempo en tu escuela</h1>
    </div>

    <nav>
        <a href="#mapa-section">Mapa</a>
        <a href="#analisis-section">An谩lisis</a>
        <a href="#escuelas">Estaciones</a>
        <a href="#acerca-section">Nosotros</a>
        <a href="#reportes">Reportes</a>
    </nav>
</header>

    <section id="mapa-section" class="data-container">
        <h2>Mapa de Estaciones y Datos Actuales</h2>
        <div id="mapa-controles">
            <label for="variable-select">Mostrar en el mapa:</label>
            <select id="variable-select" onchange="actualizarMapaYTooltips()">
                <option value="temperatura">Temperatura</option>
                <option value="humedad">Humedad</option>
            </select>
        </div>
        <div class="mapa-y-datos">
            <div id="map" style="height: 400px;"></div>
            <div class="datos-actuales">
                <h3>Resumen R谩pido (Firebase)</h3>
                <div class="resumen-grid" id="resumen-global">
                    <div class="dato-card">
                        <h4>Estaci贸n 1</h4>
                        <p class="valor" id="temp-est1">--掳C</p>
                    </div>
                </div>
                <div id="lista-escuelas">
                </div>
            </div>
        </div>
    </section>

    <hr>

    <section id="analisis-section" class="data-container">
        <h2>An谩lisis Hist贸rico por Estaci贸n</h2>
        <div class="controles">
            <label for="estacion-select">Selecciona la Estaci贸n:</label>
            <select id="estacion-select" onchange="cargarGraficosDeSeleccion()"></select>
        </div>
        
        <div class="resumen-historico">
            <h3>Resumen Hist贸rico de la Selecci贸n</h3>
            <div class="resumen-grid">
                <div class="dato-card">
                    <h4>M谩x. Temp.<br><small>(D铆a Calendario 00z)</small></h4>
                    <p class="valor" id="temp-max">-- 掳C</p>
                </div>
                <div class="dato-card">
                    <h4>Min. Temp.<br><small>(D铆a Calendario 00z)</small></h4>
                    <p class="valor" id="temp-min">-- 掳C</p>
                </div>
                <div class="dato-card">
                    <h4>Precipitaci贸n<br><small>(D铆a Met. 12z)</small></h4>
                    <p class="valor" id="precipitacion">-- mm</p>
                </div>
            </div>
        </div>

        <div class="graficos-container">
            <div class="grafico">
                <h3>Temperatura Reciente <span id="temp-date-range"></span></h3>
                <canvas id="temperaturaChart"></canvas>
            </div>
            <div class="grafico">
                <h3>Humedad Reciente <span id="hum-date-range"></span></h3>
                <canvas id="humedadChart"></canvas>
            </div>
        </div>
    </section>

    <hr>

    <section id="acerca-section" class="data-container">
        <h2>驴Quienes somos?</h2>
        <p>Somos un proyecto de extensi贸n de la Facultad de Cs. Astron贸micas y Geof铆sicas (FCAG-UNLP), formado por estudiantes avanzados de la carrera de Meteorolog铆a. Visitamos escuelas rurales y secundarias brindando talleres de meteorolog铆a, y tambi茅n recibimos a las escuelas que nos visitan en nuestra facultad.

Acercamos la ciencia del tiempo y el clima a las aulas y construimos juntos experiencias educativas 隆Aprendemos y ense帽amos con cada encuentro!.</p>
        <hr>
    <h3>Nuestros Talleres en Im谩genes</h3>
    <div class="galeria-proyecto">
        <img src="imagenes/foto-taller-1.jpg" alt="Taller del proyecto en una escuela">
        <img src="imagenes/foto-taller-2.jpg" alt="Estudiantes instalando una estaci贸n">
        <img src="imagenes/foto-taller-3.jpg" alt="Interacci贸n con estudiantes">
        <img src="imagenes/foto-taller-4.jpg" alt="Interacci贸n con estudiantes">
        <img src="imagenes/foto-taller-5.jpg" alt="Interacci贸n con estudiantes">
        </div>
        <div class="galeria-reportes" id="galeria-reportes">
            <p>Cargando reportes...</p>
        </div>
    </section>

    <footer>
        <p>&copy; 2025 Proyecto UNLP | Contacto: tiempoentuescuela@gmail.com</p>
    </footer>

    <script>
        // Configuraci贸n de Firebase
        const firebaseConfig = {
            databaseURL: "https://pagina-comoestaeltiempo-default-rtdb.firebaseio.com",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Configuraci贸n de las estaciones
        const ESTACIONES = {
            // Estaci贸n con un solo canal para todos los datos
            "observatorio": { 
                "api_url": "https://api.thingspeak.com/channels/2823820/feeds.json?results=1000&api_key=FFI1HK80ZKDNS6V8", 
                "lat": --34.90665609471138,
                "lon": -57.93240683025427, 
                "nombre": "Observatorio Campbell ", 
                "campo_temp": "field1",
                "campo_hum": "field2",
                "campo_precip": "field5", // Corregido a field5 (Rain_mm_Total)
                "foto_url": "imagenes/observatorio.png"
            },
            
            //  NUEVA ESTACIN: EMA VIOLETA (Ubicaci贸n en Campbell)
            "emavioleta": {
                "api_url": "https://api.thingspeak.com/channels/2626952/feeds.json?results=1000&api_key=AXYH56YSV64HE17H", 
                // Misma latitud/longitud que el observatorio Campbell
                "lat": -34.90483, 
                "lon": -57.93570, 
                "nombre": "Ema Violeta", 
                "campo_temp": "field1",
                "campo_hum": "field2",
                "campo_precip": "field5", // Asumimos field1, ajusta si es otro campo de precipitaci贸n
                "foto_url": "imagenes/emavioleta.png" // Agregar imagen si es necesario
            },
            // FIN DE LA NUEVA ESTACIN
            
            // Estaci贸n con canal separado para precipitaci贸n (隆REEMPLAZA LOS EJEMPLOS!)
            "escuela23": {
                // API principal (Temp/Hum)
                "api_url": "https://api.thingspeak.com/channels/2218686/feeds.json?results=1000&api_key=JUXJQRZMFFASO37Z", 
                "lat": -35.028220624725385, 
                "lon": -57.75292481051298, 
                "nombre": "Escuela N掳23 ",
                "campo_temp": "field1",
                "campo_hum": "field2",
                // API de Precipitaci贸n (DEBES REEMPLAZAR ESTE EJEMPLO)
                "api_url_precip": "https://api.thingspeak.com/channels/XXXXXX/feeds.json?results=1000&api_key=YYYYYYYYYYYYYY", 
                "campo_precip": "field1", // Campo de precipitaci贸n en el canal secundario
                "foto_url": "imagenes/escuela23.jpg" 
            },

            // Estaci贸n con un solo canal para todos los datos
            "sanvicente": {
                "api_url": "https://api.thingspeak.com/channels/2218687/feeds.json?results=1000&api_key=TH3V4TJLPRFZD3JSG", 
                "lat": -34.90315315209218, 
                "lon": -57.94890339765153, 
                "nombre": "San Vicente de Paul",
                "campo_temp": "field1",
                "campo_hum": "field2",
                "campo_precip": "field3",
                "foto_url": "imagenes/Sanvicentedepaul.png" 
            },

            //  ESTACIN AGREGADA: EMA Punta Indio
            "puntaindio": {
                "api_url": "https://api.thingspeak.com/channels/3149195/feeds.json?results=1000&api_key=8J0IFWSGB74Q8O54", 
                "lat": -35.28, 
                "lon": -57.26, 
                "nombre": "EMA Punta Indio",
                "campo_temp": "field1", 
                "campo_hum": "field3", 
                "campo_precip": "field6",
                "foto_url": "imagenes/puntaindio.png" 
            },
            // FIN DE LA NUEVA ESTACIN

            // Estaci贸n con canal separado para precipitaci贸n (隆REEMPLAZA LOS EJEMPLOS!)
            "escuela34": {
                // API principal (Temp/Hum)
                "api_url": "https://api.thingspeak.com/channels/2667270/feeds.json?results=1000&api_key=ZLNOSLZJPQM3H7SD", 
                "lat": -35.07345166939612, 
                "lon": -57.87082581096881, 
                "nombre": "Escuela N掳34",
                "campo_temp": "field1",
                "campo_hum": "field2",
                // API de Precipitaci贸n (DEBES REEMPLAZAR ESTE EJEMPLO)
                "api_url_precip": "https://api.thingspeak.com/channels/WWWWWW/feeds.json?results=1000&api_key=ZZZZZZZZZZZZZZ", 
                "campo_precip": "field1", // Campo de precipitaci贸n en el canal secundario
                "foto_url": "imagenes/escuela34.jpg" 
            },
            
            // =========================================================================
            //  CORRECCIN 1: Clave "estacion3" renombrada a "escuela20" 
            // Esto AHORA coincide con la clave que usa el script de Firebase.
            // =========================================================================
            "escuela20": {
                "api_url": "https://api.thingspeak.com/channels/3158942/feeds.json?results=1000&api_key=41C05TXQE8N5NRB2",
                "lat": -34.95100438126944, 
                "lon": -57.83513895065668, 
                "nombre": "Escuela N掳20 y ES 7 ",
                //  CORRECCIN 2: Campos ajustados a ThingSpeak (seg煤n tu Ema.py)
                "campo_temp": "field2", // Era "OutTemp" en tu script Ema.py
                "campo_hum": "field3", // Era "OutHumi" en tu script Ema.py
                "campo_precip": "field6", // Era "Rain" en tu script Ema.py
                "foto_url": "imagenes/ep20.png"
            }
        };
        
        // Se inicializa el mapa usando la clave 'observatorio'
        const map = L.map('map').setView([ESTACIONES.observatorio.lat, ESTACIONES.observatorio.lon], 13);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '漏 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const markers = {};
        const listaEscuelas = document.getElementById('lista-escuelas');
        const estacionSelect = document.getElementById('estacion-select');
        const galeriaReportes = document.getElementById('galeria-reportes');
        const variableSelect = document.getElementById('variable-select');

        // FUNCIN AUXILIAR PARA DAR FORMATO A LA FECHA Y HORA
        function formatDateTime(dateString) {
            if (!dateString) return 'Desconocida';
            const date = new Date(dateString); 
            
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            const dateOptions = { day: '2-digit', month: 'short' };
            
            const time = date.toLocaleTimeString('es-AR', timeOptions);
            const dateOnly = date.toLocaleDateString('es-AR', dateOptions);
            
            return `${time} hs (${dateOnly})`;
        }
        
        // Funci贸n para cargar reportes desde el CMS (SIN CAMBIOS)
        async function cargarReportes() {
            try {
                const response = await fetch('/_data/reportes/index.json'); 
                const reportes = await response.json();

                galeriaReportes.innerHTML = ''; 
                reportes.sort((a, b) => new Date(b.date) - new Date(a.date));

                reportes.forEach(reporte => {
                    const divCard = document.createElement('div');
                    divCard.className = 'reporte-card';
                    const imgSrc = reporte.image || 'imagenes/placeholder.jpg'; 
                    
                    divCard.innerHTML = `
                        <img src="${imgSrc}" alt="${reporte.title}">
                        <h4>${reporte.title}</h4>
                        <p>Fecha: ${reporte.date} | Escuela: ${reporte.school || 'General'}</p>
                        <p>${reporte.summary}</p>
                        <a href="#">Ver Detalles</a>
                    `;
                    galeriaReportes.appendChild(divCard);
                });

            } catch (error) {
                console.warn("No se pudo cargar la lista de reportes, el CMS a煤n no ha publicado contenido o la ruta es incorrecta.");
                galeriaReportes.innerHTML = `<p>El contenido din谩mico de Talleres y Reportes se cargar谩 aqu铆 cuando los coordinadores publiquen el primer art铆culo a trav茅s del CMS.</p>`;
            }
        }
        
        // Funci贸n para inicializar los marcadores de Leaflet (SIN CAMBIOS)
        function inicializarMarcadores() {
            for (const key in ESTACIONES) {
                const configEstacion = ESTACIONES[key];
                
                const marker = L.marker([configEstacion.lat, configEstacion.lon]).addTo(map);
                markers[key] = marker;
                
                const initialContent = `${configEstacion.nombre}<br><b>Cargando...</b>`;
                
                marker.bindTooltip(initialContent, {
                    permanent: true,
                    direction: 'top',
                    className: 'weather-tooltip'
                }).openTooltip();
                
                marker.bindPopup(initialContent);
            }
            map.setView([ESTACIONES[Object.keys(ESTACIONES)[0]].lat, ESTACIONES[Object.keys(ESTACIONES)[0]].lon], 13);
        }

        // FUNCIN PARA ACTUALIZAR TOOLTIPS (Incluye hora) - (SIN CAMBIOS)
        function actualizarMapaYTooltips(variable = variableSelect.value, data = null) {
            for (const key in markers) {
                const configEstacion = ESTACIONES[key];
                const marker = markers[key];
                
                const estacionData = data && data[key] ? data[key] : { temperatura: '--', humedad: '--', ultima_actualizacion: null }; 
                
                let valor = estacionData[variable] !== undefined ? estacionData[variable] : '--';
                let unidad = variable === 'temperatura' ? '掳C' : '%';
                
                const horaFormateada = formatDateTime(estacionData.ultima_actualizacion);

                if (typeof valor === 'string' && valor !== '--') {
                    valor = parseFloat(valor).toFixed(1);
                }

                const tooltipContent = `${configEstacion.nombre}<br><b>${variable.charAt(0).toUpperCase() + variable.slice(1)}: ${valor}${unidad}</b><br><small>Actualizado: ${horaFormateada}</small>`;
                
                const popupContent = `
                    <b>${configEstacion.nombre}</b><br>
                    Temp: ${estacionData.temperatura}掳C<br>
                    Humedad: ${estacionData.humedad}%<br>
                    <small>ltimo dato: ${horaFormateada}</small>
                `;

                marker.getTooltip().setContent(tooltipContent);
                marker.setPopupContent(popupContent);
            }
        }
        
        // Escuchar datos en tiempo real de Firebase para actualizar el mapa (SIN CAMBIOS)
        db.ref('estaciones').on('value', (snapshot) => {
            const estaciones = snapshot.val();
            if (estaciones) {
                actualizarMapaYTooltips(variableSelect.value, estaciones);
            }
        });

        // Poblar select y lista (SIN CAMBIOS)
        function poblarSelectyLista() {
            estacionSelect.innerHTML = '';
            listaEscuelas.innerHTML = '';

            for (const key in ESTACIONES) {
                const estacion = ESTACIONES[key];
                
                const option = document.createElement('option');
                option.value = key;
                option.textContent = estacion.nombre;
                estacionSelect.appendChild(option);

                const divCard = document.createElement('div');
                divCard.className = 'escuela-card';
                divCard.innerHTML = `<img src="${estacion.foto_url}" alt="Foto de ${estacion.nombre}"><h4>${estacion.nombre}</h4>`;
                listaEscuelas.appendChild(divCard);
            }
        }

        const temperaturaCtx = document.getElementById('temperaturaChart').getContext('2d');
        const humedadCtx = document.getElementById('humedadChart').getContext('2d');
        let temperaturaChart, humedadChart;

        function getFieldValue(feed, path) {
            const parts = path.split('.');
            let value = feed;
            for (const part of parts) {
                if (value && value[part] !== undefined) {
                    value = value[part];
                } else {
                    return undefined;
                }
            }
            return value;
        }

// =========================================================================
// FUNCIN CORREGIDA: Cambio de estaci贸n y orden cronol贸gico del tiempo
// =========================================================================
async function cargarGraficos(estacionKey) {
    const estacion = ESTACIONES[estacionKey];
    
    //  CORRECCIN 3: ELIMINADO el bloque `if (estacionKey === "estacion3")` 
    // Ya no es necesario, "escuela20" (antes "estacion3") es una estaci贸n normal.

    if (!estacion) {
        console.error("Estaci贸n no encontrada:", estacionKey);
        return;
    }

    try {
        // 1. Fetch de datos principales (Temperatura/Humedad)
        const responsePrincipal = await fetch(estacion.api_url);
        const dataPrincipal = await responsePrincipal.json();
        
        // 2. Fetch de datos de Precipitaci贸n
        let feedsPrecipitacion = [];
        let campoPrecipitacion = estacion.campo_precip;

        if (estacion.api_url_precip) {
             const responsePrecip = await fetch(estacion.api_url_precip);
             const dataPrecip = await responsePrecip.json();
             feedsPrecipitacion = dataPrecip.feeds;
        } else {
             feedsPrecipitacion = dataPrincipal.feeds;
        }

        let feeds = dataPrincipal.feeds; // Feeds completos (ThingSpeak es newest first)

        
        //  LGICA DE TIEMPO BASE
        const now = new Date();
        // 00:00 UTC del d铆a de hoy (para M谩x/M铆n Diario)
        const startOfTodayUtc = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0));
        // Hace 24 horas (para el Gr谩fico)
        const startOfLast24Hours = new Date(now.getTime() - (24 * 60 * 60 * 1000)); 
        
        // ----------------------------------------------------------------------------------
        // FILTRADO DE DATOS
        
        const tempsDelDiaCalendario = [];  // Para Max/Min (00z-now)
        const feedsParaGrafico_ReverseOrder = [];  // Para Gr谩fico (Last 24 hours - Newest first)

        for (const feed of feeds) {
            const timestamp = new Date(feed.created_at);
            const tempValue = parseFloat(getFieldValue(feed, estacion.campo_temp));
            
            // 1. Filtrado para M谩x/M铆n del D铆a Calendario (00z a now)
            if (timestamp >= startOfTodayUtc && timestamp <= now) {
                if (!isNaN(tempValue)) tempsDelDiaCalendario.push(tempValue);
            }

            // 2. Filtrado para el Gr谩fico (ltimas 24 horas)
            if (timestamp >= startOfLast24Hours && timestamp <= now) {
                 // SLO agregamos el feed, no se modifica el orden aqu铆.
                 feedsParaGrafico_ReverseOrder.push(feed); 
            }
        }
        
        // 3. CLCULO de M谩x/M铆n
        const maxTemp = tempsDelDiaCalendario.length > 0 ? Math.max(...tempsDelDiaCalendario).toFixed(2) : '--';
        const minTemp = tempsDelDiaCalendario.length > 0 ? Math.min(...tempsDelDiaCalendario).toFixed(2) : '--';

        document.getElementById('temp-max').textContent = `${maxTemp} 掳C`;
        document.getElementById('temp-min').textContent = `${minTemp} 掳C`;

        // ----------------------------------------------------------------------------------
        // LGICA PARA CLCULO DE PRECIPITACIN (DA METEOROLGICO: 12z-12z)
        const doceUtc = 12;

        let endRangePrecip = new Date(startOfTodayUtc); 
        endRangePrecip.setUTCHours(doceUtc); 
        
        if (now.getUTCHours() < doceUtc) {
            // Si la hora actual es antes de las 12 UTC, el d铆a meteorol贸gico termin贸 a las 12 UTC de ayer.
            endRangePrecip.setUTCDate(endRangePrecip.getUTCDate() - 1); 
        }
        
        let startRangePrecip = new Date(endRangePrecip);
        startRangePrecip.setUTCDate(startRangePrecip.getUTCDate() - 1); // 24 horas antes del final

        const valoresPrecipitacion = [];

        for (const feed of feedsPrecipitacion) {
            const timestamp = new Date(feed.created_at);
            const precipValue = parseFloat(getFieldValue(feed, campoPrecipitacion)); 

            if (timestamp >= startRangePrecip && timestamp <= endRangePrecip && !isNaN(precipValue) && precipValue !== null) {
                valoresPrecipitacion.push(precipValue);
            }
        }
        
        // 3. CLCULO DE PRECIPITACIN COMO DIFERENCIA (MAX - MIN)
        let totalPrecip = '--';

        if (valoresPrecipitacion.length > 0) {
            const maxPrecip = Math.max(...valoresPrecipitacion);
            const minPrecip = Math.min(...valoresPrecipitacion);
            
            totalPrecip = (maxPrecip - minPrecip).toFixed(2);
        }
        
        document.getElementById('precipitacion').textContent = `${totalPrecip} mm`; 
        
        // ----------------------------------------------------------------------------------
        
        // CREACIN DE DATOS PARA GRFICOS
        
        //  CORRECCIN CLAVE: Usamos el operador spread ([...]) para copiar el array
        // y luego lo invertimos (Pasado -> Presente).
        const feedsParaGrafico_chronological = [...feedsParaGrafico_ReverseOrder].reverse(); 

        const labels = feedsParaGrafico_chronological.map(feed => {
            const date = new Date(feed.created_at);
            return date.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
        }); 
        
        const temperaturas = feedsParaGrafico_chronological.map(feed => parseFloat(getFieldValue(feed, estacion.campo_temp))).filter(val => !isNaN(val));
        const humedades = feedsParaGrafico_chronological.map(feed => parseFloat(getFieldValue(feed, estacion.campo_hum))).filter(val => !isNaN(val));

        
        let dateRangeText = '';
        if (feedsParaGrafico_chronological.length > 0) {
            const firstDate = new Date(feedsParaGrafico_chronological[0].created_at); 
            const lastDate = new Date(feedsParaGrafico_chronological[feedsParaGrafico_chronological.length - 1].created_at);
            
            const timeFormat = { hour: '2-digit', minute: '2-digit' };
            const dateFormat = { day: '2-digit', month: 'short' };
            
            const startLabel = `${firstDate.toLocaleDateString('es-AR', dateFormat)} ${firstDate.toLocaleTimeString('es-AR', timeFormat)}`;
            const endLabel = `${lastDate.toLocaleDateString('es-AR', dateFormat)} ${lastDate.toLocaleTimeString('es-AR', timeFormat)}`;

            dateRangeText = `(${startLabel} - ${endLabel})`;
        } else {
             dateRangeText = `(Sin datos en las 煤ltimas 24hs)`;
        }
        document.getElementById('temp-date-range').textContent = dateRangeText;
        document.getElementById('hum-date-range').textContent = dateRangeText;

        // ** Chart.js - Temperatura **
        if (temperaturaChart) temperaturaChart.destroy(); // Asegurar destrucci贸n si no se hizo antes
        temperaturaChart = new Chart(temperaturaCtx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Temperatura (掳C)', data: temperaturas, borderColor: 'orange', backgroundColor: 'rgba(255, 165, 0, 0.2)', tension: 0.3, fill: true }] },
            options: { 
                responsive: true, 
                scales: { 
                    y: { beginAtZero: false },
                    x: { 
                        title: { display: true, text: 'Hora (HH:MM)'},
                        reverse: false // Correcto: tiempo avanza de izquierda a derecha
                    } 
                } 
            }
        });

        // ** Chart.js - Humedad **
        if (humedadChart) humedadChart.destroy(); // Asegurar destrucci贸n si no se hizo antes
        humedadChart = new Chart(humedadCtx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Humedad (%)', data: humedades, borderColor: 'blue', backgroundColor: 'rgba(58, 165, 230, 0.2)', tension: 0.3, fill: true }] },
            options: { 
                responsive: true, 
                scales: { 
                    y: { beginAtZero: true, max: 100 },
                    x: { 
                        title: { display: true, text: 'Hora (HH:MM)'},
                        reverse: false // Correcto: tiempo avanza de izquierda a derecha
                    } 
                } 
            }
        });

    } catch (error) {
        console.error("Error al cargar datos hist贸ricos (Revisa la configuraci贸n de la API o la conexi贸n a internet):", error);
    }
}
// =========================================================================

        // FUNCIN MODIFICADA: Ahora redirige si se selecciona la EMA IARANA2 (DESTRUYE GRFICOS)
        function cargarGraficosDeSeleccion() {
            // 1.  DESTRUYE LOS GRFICOS PREVIOS AQU 
            if (temperaturaChart) temperaturaChart.destroy();
            if (humedadChart) humedadChart.destroy();

            const selectedKey = estacionSelect.value;
            const estacion = ESTACIONES[selectedKey];

            //  CORRECCIN 3: ELIMINADO el bloque `if (selectedKey === "estacion3")` 
            // Ya no es necesario, "escuela20" (antes "estacion3") es una estaci贸n normal.
            
            // 2. Cargar los nuevos gr谩ficos de la estaci贸n seleccionada
            cargarGraficos(selectedKey);
        }

        document.addEventListener('DOMContentLoaded', () => {
            inicializarMarcadores(); 
            poblarSelectyLista(); 
            cargarReportes(); 
            
            // Carga el gr谩fico inicial
            //  CORRECCIN 3: Simplificada esta l贸gica 
            const primeraEstacionKey = Object.keys(ESTACIONES)[0]; // Simplemente carga la primera estaci贸n
            if (primeraEstacionKey) {
                cargarGraficos(primeraEstacionKey);
            }
        });
    </script>
</body>
</html>
