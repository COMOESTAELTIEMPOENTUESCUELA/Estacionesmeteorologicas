<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¿Cómo Está el Tiempo? - UNLP</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIINfBTxTRj3iTTGAWpIBl8EQAylAUdbSPls="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20n6a9c8b98zI26kO2aK9C3J6B9A34C48F/k0M7wE4Kz0="
            crossorigin=""></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.19.1/firebase-database.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header>
        <h1>Proyecto Meteorológico Escolar UNLP</h1>
        <nav>
            <a href="#mapa-section">Mapa de Estaciones</a>
            <a href="#analisis-section">Análisis Histórico</a>
            <a href="#talleres-section">Talleres y Reportes</a>
        </nav>
    </header>

    <section id="mapa-section" class="data-container">
        <h2>Mapa de Estaciones y Datos Actuales</h2>
        <div class="mapa-y-datos">
            <div id="map" style="height: 400px;"></div>
            <div class="datos-actuales">
                <h3>Resumen Rápido (Firebase)</h3>
                <div class="resumen-grid" id="resumen-global">
                    <div class="dato-card">
                        <h4>Estación 1</h4>
                        <p class="valor" id="temp-est1">--°C</p>
                    </div>
                </div>
                <div id="lista-escuelas">
                </div>
            </div>
        </div>
    </section>

    <hr>

    <section id="analisis-section" class="data-container">
        <h2>Análisis Histórico por Estación</h2>
        <div class="controles">
            <label for="estacion-select">Selecciona la Estación:</label>
            <select id="estacion-select" onchange="cargarGraficosDeSeleccion()"></select>
        </div>
        
        <div class="resumen-historico">
            <h3>Resumen Histórico de la Selección</h3>
            <div class="resumen-grid">
                <div class="dato-card">
                    <h4>Máx. Temp.</h4>
                    <p class="valor" id="temp-max">-- °C</p>
                </div>
                <div class="dato-card">
                    <h4>Min. Temp.</h4>
                    <p class="valor" id="temp-min">-- °C</p>
                </div>
                <div class="dato-card">
                    <h4>Precipitación</h4>
                    <p class="valor" id="precipitacion">-- mm</p>
                </div>
            </div>
        </div>

        <div class="graficos-container">
            <div class="grafico">
                <h3>Temperatura Reciente</h3>
                <canvas id="temperaturaChart"></canvas>
            </div>
            <div class="grafico">
                <h3>Humedad Reciente</h3>
                <canvas id="humedadChart"></canvas>
            </div>
        </div>
    </section>

    <hr>

    <section id="talleres-section" class="data-container">
        <h2>Talleres y Reportes de las Escuelas</h2>
        <p>Aquí se publicarán las actividades de coordinación y los reportes fotográficos de nuestros colaboradores.</p>
        
        <div class="galeria-reportes" id="galeria-reportes">
            <p>Cargando reportes...</p>
        </div>
    </section>

    <footer>
        <p>&copy; 2025 Proyecto UNLP | Contacto: [Tu Email]</p>
    </footer>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            databaseURL: "https://pagina-comoestaeltiempo-default-rtdb.firebaseio.com",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Configuración de las estaciones
        const ESTACIONES = {
            "estacion1": {
                "api_url": "https://api.thingspeak.com/channels/2667267/feeds.json?results=100&api_key=UF1X79VA5C55SROZ",
                "lat": -34.965,
                "lon": -57.947,
                "nombre": "Estación UNLP (ThingSpeak)",
                "campo_temp": "field1",
                "campo_hum": "field2",
                "campo_precip": "field3",
                "foto_url": "imagenes/foto_escuela_1.jpg"
            },
            "estacion2": {
                // ** IMPORTANTE: REEMPLAZAR ESTA URL **
                "api_url": "URL_DE_API_DE_THINGSPEAK_2", 
                "lat": -34.96,
                "lon": -57.90,
                "nombre": "Colegio Ejemplo 2 (ThingSpeak)",
                "campo_temp": "field1",
                "campo_hum": "field2",
                "campo_precip": "field3",
                "foto_url": "imagenes/foto_escuela_2.jpg"
            },
            "estacion3": {
                // ** ESTACIÓN WUNDERMAP (Mantiene la URL compleja para la lógica JS) **
                "api_url": "https://api.weather.com/v2/pws/observations/all?stationId=IARANA2&format=json&units=m&numericPrecision=decimal&apiKey=d325ae34959d4853a5ae34959d1853ea",
                "lat": -34.9680, 
                "lon": -57.9450, 
                "nombre": "Escuela IARANA2 (WunderMap)",
                "campo_temp": "metric.temp", 
                "campo_hum": "humidity", 
                "campo_precip": "metric.precipTotal",
                "foto_url": "imagenes/foto_escuela_3.jpg"
            }
        };

        const map = L.map('map').setView([ESTACIONES.estacion1.lat, ESTACIONES.estacion1.lon], 13);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        const markers = {};
        const listaEscuelas = document.getElementById('lista-escuelas');
        const estacionSelect = document.getElementById('estacion-select');
        const galeriaReportes = document.getElementById('galeria-reportes');

        // *** FUNCIÓN PARA CARGAR REPORTES DESDE EL CMS ***
        async function cargarReportes() {
            try {
                // Busca el archivo index.json que Decap CMS crea en la carpeta _data/reportes
                const response = await fetch('/_data/reportes/index.json'); 
                const reportes = await response.json();

                galeriaReportes.innerHTML = ''; // Limpia el contenido "Cargando reportes..."
                
                // Ordenar por fecha (más reciente primero)
                reportes.sort((a, b) => new Date(b.date) - new Date(a.date));

                reportes.forEach(reporte => {
                    const divCard = document.createElement('div');
                    divCard.className = 'reporte-card';
                    const imgSrc = reporte.image || 'imagenes/placeholder.jpg'; // Usa una imagen por defecto si no hay
                    
                    divCard.innerHTML = `
                        <img src="${imgSrc}" alt="${reporte.title}">
                        <h4>${reporte.title}</h4>
                        <p>Fecha: ${reporte.date} | Escuela: ${reporte.school || 'General'}</p>
                        <p>${reporte.summary}</p>
                        <a href="#">Ver Detalles</a>
                    `;
                    galeriaReportes.appendChild(divCard);
                });

            } catch (error) {
                // Esto es común si la página se carga antes de que se cree el primer archivo index.json por el CMS.
                console.warn("No se pudo cargar la lista de reportes, el CMS aún no ha publicado contenido o la ruta es incorrecta.");
                galeriaReportes.innerHTML = `<p>El contenido dinámico de Talleres y Reportes se cargará aquí cuando los coordinadores publiquen el primer artículo a través del CMS.</p>`;
            }
        }
        // *************************************************

        // Función para poblar la lista de escuelas y el selector
        function poblarSelectyLista() {
            estacionSelect.innerHTML = '';
            listaEscuelas.innerHTML = '';

            for (const key in ESTACIONES) {
                const estacion = ESTACIONES[key];
                
                const option = document.createElement('option');
                option.value = key;
                option.textContent = estacion.nombre;
                estacionSelect.appendChild(option);

                const divCard = document.createElement('div');
                divCard.className = 'escuela-card';
                divCard.innerHTML = `<img src="${estacion.foto_url}" alt="Foto de ${estacion.nombre}"><h4>${estacion.nombre}</h4>`;
                listaEscuelas.appendChild(divCard);
            }
        }
        
        // Escuchar datos en tiempo real de Firebase para actualizar el mapa
        db.ref('estaciones').on('value', (snapshot) => {
            const estaciones = snapshot.val();
            if (estaciones) {
                for (const key in estaciones) {
                    const estacion = estaciones[key];
                    const configEstacion = ESTACIONES[key];
                    if (configEstacion) {
                        if (markers[key]) {
                            markers[key].setLatLng([configEstacion.lat, configEstacion.lon])
                                .setPopupContent(`<b>${configEstacion.nombre}</b><br>Temp: ${estacion.temperatura}°C<br>Humedad: ${estacion.humedad}%`);
                        } else {
                            const marker = L.marker([configEstacion.lat, configEstacion.lon]).addTo(map);
                            marker.bindPopup(`<b>${configEstacion.nombre}</b><br>Temp: ${estacion.temperatura}°C<br>Humedad: ${estacion.humedad}%`);
                            markers[key] = marker;
                        }
                    }
                }
            }
        });

        const temperaturaCtx = document.getElementById('temperaturaChart').getContext('2d');
        const humedadCtx = document.getElementById('humedadChart').getContext('2d');
        let temperaturaChart, humedadChart;

        async function cargarGraficos(estacionKey) {
            const estacion = ESTACIONES[estacionKey];
            if (!estacion) {
                console.error("Estación no encontrada:", estacionKey);
                return;
            }

            try {
                const response = await fetch(estacion.api_url);
                const data = await response.json();
                
                let feeds = data.feeds;
                
                if (estacionKey.includes("estacion3")) { 
                    if (data.observations && data.observations.length > 0) {
                        feeds = data.observations; 
                    } else {
                        document.getElementById('temp-max').textContent = '--';
                        document.getElementById('temp-min').textContent = '--';
                        document.getElementById('precipitacion').textContent = '--';
                        if (temperaturaChart) temperaturaChart.destroy();
                        if (humedadChart) humedadChart.destroy();
                        return;
                    }
                }

                function getFieldValue(feed, path) {
                    if (estacionKey.includes("estacion3")) {
                        const parts = path.split('.');
                        let value = feed;
                        for (const part of parts) {
                            if (value && value[part] !== undefined) {
                                value = value[part];
                            } else {
                                return undefined;
                            }
                        }
                        return value;
                    } else {
                        return feed[path];
                    }
                }

                const labels = feeds.map(feed => {
                    if (estacionKey.includes("estacion3")) {
                        return new Date(feed.obsTimeUtc).toLocaleString();
                    } else {
                        return new Date(feed.created_at).toLocaleString();
                    }
                });
                
                const temperaturas = feeds.map(feed => parseFloat(getFieldValue(feed, estacion.campo_temp))).filter(val => !isNaN(val));
                const humedades = feeds.map(feed => parseFloat(getFieldValue(feed, estacion.campo_hum))).filter(val => !isNaN(val));
                const precipitaciones = feeds.map(feed => parseFloat(getFieldValue(feed, estacion.campo_precip) || 0)).filter(val => !isNaN(val));
                
                const maxTemp = temperaturas.length > 0 ? Math.max(...temperaturas).toFixed(2) : '--';
                const minTemp = temperaturas.length > 0 ? Math.min(...temperaturas).toFixed(2) : '--';
                const totalPrecip = precipitaciones.length > 0 ? precipitaciones.reduce((sum, val) => sum + val, 0).toFixed(2) : '--';

                document.getElementById('temp-max').textContent = maxTemp;
                document.getElementById('temp-min').textContent = minTemp;
                document.getElementById('precipitacion').textContent = totalPrecip;
                
                if (temperaturaChart) temperaturaChart.destroy();
                if (humedadChart) humedadChart.destroy();

                temperaturaChart = new Chart(temperaturaCtx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'Temperatura (°C)', data: temperaturas, borderColor: 'var(--color-accent-red)', backgroundColor: 'rgba(255, 76, 76, 0.2)', tension: 0.3, fill: true }] },
                    options: { responsive: true, scales: { y: { beginAtZero: false } } }
                });

                humedadChart = new Chart(humedadCtx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'Humedad (%)', data: humedades, borderColor: 'var(--color-primary-blue)', backgroundColor: 'rgba(58, 165, 230, 0.2)', tension: 0.3, fill: true }] },
                    options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
                });

            } catch (error) {
                console.error("Error al cargar datos históricos (Revisa la configuración de la API):", error);
            }
        }

        function cargarGraficosDeSeleccion() {
            const selectedKey = estacionSelect.value;
            cargarGraficos(selectedKey);
        }

        document.addEventListener('DOMContentLoaded', () => {
            poblarSelectyLista(); // Carga las tarjetas de escuelas
            cargarReportes();     // LLAMADA A LA NUEVA FUNCIÓN DEL CMS
            
            const primeraEstacionKey = Object.keys(ESTACIONES)[0];
            if (primeraEstacionKey) {
                cargarGraficos(primeraEstacionKey);
            }
        });
    </script>
</body>
</html>
